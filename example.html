<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gauntlet Arena: Equipment Fixed</title>
    <style>
        body { background-color: #0a0a0f; color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; }
        canvas { border: 4px solid #464664; background-color: #14141e; box-shadow: 0 0 50px rgba(0,0,0,1); }
    </style>
</head>
<body>

<canvas id="gameCanvas" width="960" height="650"></canvas>

<script>
/**
 * --- GAME CONFIGURATION ---
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const COLORS = {
    WHITE: "#FFFFFF", BLACK: "#000000", RED: "#FF4646", GREEN: "#46FF46",
    GRAY: "#646464", GOLD: "#FFD700", YELLOW: "#FFFF00", 
    DARK_BG: "#0a0a0f", CYAN: "#00FFFF", PANEL: "rgba(40, 40, 60, 0.95)", 
    ENEMY_PANEL: "rgba(60, 40, 40, 0.85)", LOG_BG: "rgba(5, 5, 10, 0.9)",
    SLOT_BG: "rgba(20, 20, 30, 0.9)", RARITY_COMMON: "#FFFFFF", RARITY_RARE: "#46A0FF", RARITY_EPIC: "#A335EE"
};

const ZONE_NAMES = { "1": "Head", "2": "Chest", "3": "Stomach", "4": "Belt", "5": "Legs" };

const ENEMY_DATA = [
    ["Scavenger Scout", 60, 10, 0.05], ["Iron-Clad Guard", 160, 12, 0.02],
    ["Arcane Scribe", 100, 22, 0.10], ["Stalker Prowler", 130, 18, 0.35],
    ["Hollowed Sentinel", 250, 20, 0.05], ["Void-Caller Acolyte", 200, 30, 0.10],
    ["Blood-Oath Duelist", 220, 35, 0.20], ["Ruin-Knight Exemplar", 400, 45, 0.00],
    ["Void-General Malakor", 500, 55, 0.15], ["AETHELGARD", 1000, 80, 0.10]
];

const ALL_ITEMS = [
    {name: "Rusty Dagger", type: "weapon", STR: 2, LUCK: 1, rarity: "COMMON"},
    {name: "Soldier's Sword", type: "weapon", STR: 5, LUCK: 2, rarity: "COMMON"},
    {name: "Heavy Mace", type: "weapon", STR: 8, LUCK: 0, rarity: "COMMON"},
    {name: "Void Reaver", type: "weapon", STR: 12, LUCK: 5, rarity: "RARE"},
    {name: "Dragon Tooth", type: "weapon", STR: 15, LUCK: 3, rarity: "EPIC"},
    {name: "Lucky Coin", type: "weapon", STR: 1, LUCK: 12, rarity: "RARE"},
    {name: "Leather Tunic", type: "armor", STA: 2, DEX: 1, rarity: "COMMON"},
    {name: "Reinforced Garb", type: "armor", STA: 4, DEX: 3, rarity: "COMMON"},
    {name: "Plate Mail", type: "armor", STA: 8, DEX: -2, rarity: "COMMON"},
    {name: "Ninja Suit", type: "armor", STA: 2, DEX: 10, rarity: "RARE"},
    {name: "Dragon Scale", type: "armor", STA: 12, DEX: 4, rarity: "EPIC"},
    {name: "Void Cloak", type: "armor", STA: 6, DEX: 12, rarity: "EPIC"}
];

const assets = {};
function load(key, path) {
    const img = new Image();
    img.src = path;
    assets[key] = img;
}

// ASSET LOADING
load('player', 'assets/player.png');
for(let i=1; i<=10; i++) load(`enemy_${i}`, `assets/enemy_lvl_${i}.png`);
Object.keys(ZONE_NAMES).forEach(id => load(`icon_${id}`, `assets/${ZONE_NAMES[id].toLowerCase()}.png`));

// FIX: Ensure both Weapons and Armor icons are loaded by normalizing the name
ALL_ITEMS.forEach(item => {
    const fileName = item.name.toLowerCase().replace(/ /g, '_');
    load(item.name, `assets/${fileName}.png`);
});

function drawSprite(key, x, y, w, h, label, color) {
    if (assets[key] && assets[key].complete && assets[key].naturalWidth !== 0) {
        ctx.drawImage(assets[key], x, y, w, h);
    } else {
        ctx.fillStyle = color || "rgba(50, 50, 50, 0.5)";
        ctx.fillRect(x, y, w, h);
        ctx.fillStyle = "white";
        ctx.font = "bold 12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(label || key, x + w/2, y + h/2);
    }
}

let state = "menu", userName = "", score = 0, currentLvl = 1;
let player = {}, enemy = {}, log = [];
let selAtk = null, selBlk = [];
let pDisplayHp = 0, eDisplayHp = 0, hpStart = 0;
let highScores = JSON.parse(localStorage.getItem('gauntletScores')) || [];
let logScroll = 0, hoveredItem = null, tooltipPos = {x:0, y:0};

function addLog(txt, col) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString([], {hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit'});
    log.push({txt, col, time: timeStr});
    logScroll = Math.max(0, log.length - 5);
}

function initPlayer() {
    player = { STR: 5, DEX: 5, STA: 5, LUCK: 5, hp: 0, maxHp: 0, weapon: null, armor: null, inventory: [], points: 0, bonus: {} };
    calcStats();
    player.hp = player.maxHp; pDisplayHp = player.hp; hpStart = player.hp;
    log = [];
    addLog("Enter the Arena.", COLORS.GOLD);
}

function calcStats() {
    player.bonus = {STR: 0, DEX: 0, STA: 0, LUCK: 0};
    [player.weapon, player.armor].forEach(item => {
        if(item) {
            if(item.STR) player.bonus.STR += item.STR;
            if(item.DEX) player.bonus.DEX += item.DEX;
            if(item.STA) player.bonus.STA += item.STA;
            if(item.LUCK) player.bonus.LUCK += item.LUCK;
        }
    });
    player.maxHp = 100 + ((player.STA + player.bonus.STA) * 15);
    player.dmg = 10 + ((player.STR + player.bonus.STR) * 4);
    player.dodge = Math.min(0.60, (player.DEX + player.bonus.DEX) * 0.02);
    player.crit = Math.min(0.50, (player.LUCK + player.bonus.LUCK) * 0.03);
}

function startLevel(lvl) {
    const d = ENEMY_DATA[lvl-1];
    enemy = { name: d[0], hp: d[1], maxHp: d[1], dmg: d[2], dodge: d[3] };
    eDisplayHp = enemy.hp;
}

function render() {
    ctx.fillStyle = COLORS.DARK_BG;
    ctx.fillRect(0, 0, 960, 650);
    pDisplayHp += (player.hp - pDisplayHp) * 0.1;
    eDisplayHp += (enemy.hp - eDisplayHp) * 0.1;
    if (state === "menu") drawMenu();
    else if (state === "combat") drawCombat();
    else if (state === "inventory") drawInventory();
    else if (state === "gameover" || state === "victory") drawEnd();
    requestAnimationFrame(render);
}

function drawMenu() {
    ctx.textAlign = "center"; ctx.fillStyle = COLORS.GOLD; ctx.font = "bold 50px Arial";
    ctx.fillText("GAUNTLET ARENA", 480, 150);
    ctx.fillStyle = COLORS.WHITE; ctx.font = "20px Arial"; ctx.fillText("ENTER NAME & PRESS ENTER", 480, 280);
    ctx.fillStyle = "#28283C"; ctx.fillRect(330, 300, 300, 50);
    ctx.fillStyle = COLORS.CYAN; ctx.fillText(userName + (Math.floor(Date.now()/500)%2==0?"|":""), 480, 332);
}

function drawCombat() {
    drawSprite('player', 20, 150, 350, 350, "PLAYER"); 
    drawSprite(`enemy_${currentLvl}`, 590, 150, 350, 350, enemy.name);
    drawHealthBar(40, 100, 300, pDisplayHp, player.maxHp, userName);
    drawHealthBar(620, 100, 300, eDisplayHp, enemy.maxHp, enemy.name);

    ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
    let defLeft = 2 - selBlk.length;
    ctx.fillStyle = defLeft === 0 ? COLORS.GREEN : COLORS.CYAN;
    ctx.fillText(defLeft === 0 ? "DEFENSE SET" : `SELECT ${defLeft} DEFENSE AREAS`, 345, 140);
    
    let atkLeft = selAtk ? 0 : 1;
    ctx.fillStyle = atkLeft === 0 ? COLORS.GREEN : COLORS.RED;
    ctx.fillText(atkLeft === 0 ? "ATTACK SET" : "SELECT 1 ATTACK AREA", 615, 140);

    for(let i=1; i<=5; i++) {
        const id = i.toString();
        const yBase = 150 + (i-1) * 75;
        ctx.fillStyle = selBlk.includes(id) ? COLORS.CYAN : "rgba(40, 40, 60, 0.7)";
        ctx.fillRect(310, yBase, 70, 70); 
        drawSprite(`icon_${id}`, 315, yBase + 5, 60, 60, ZONE_NAMES[id]);
        ctx.fillStyle = selAtk === id ? COLORS.RED : "rgba(40, 40, 60, 0.7)";
        ctx.fillRect(580, yBase, 70, 70);
        drawSprite(`icon_${id}`, 585, yBase + 5, 60, 60, ZONE_NAMES[id]);
    }

    if(selAtk && selBlk.length === 2) {
        ctx.fillStyle = COLORS.GOLD; ctx.fillRect(430, 495, 100, 45);
        ctx.fillStyle = COLORS.BLACK; ctx.textAlign = "center"; ctx.font = "bold 18px Arial";
        ctx.fillText("FIGHT", 480, 525);
    }

    if (player.points > 0) {
        let pulse = 0.6 + Math.abs(Math.sin(Date.now() / 300)) * 0.4;
        ctx.fillStyle = `rgba(255, 215, 0, ${pulse})`; ctx.textAlign = "left";
        ctx.fillText(`${player.points} PT(S) AVAILABLE!`, 40, 515);
    }

    ctx.fillStyle = COLORS.GRAY; ctx.fillRect(40, 465, 180, 40);
    ctx.fillStyle = COLORS.BLACK; ctx.textAlign = "center"; ctx.font = "bold 14px Arial";
    ctx.fillText("OPEN ARMORY", 130, 490);

    ctx.fillStyle = COLORS.LOG_BG; ctx.fillRect(20, 545, 920, 95);
    log.slice(Math.floor(logScroll), Math.floor(logScroll) + 5).forEach((m, i) => {
        ctx.font = "13px monospace"; ctx.fillStyle = m.col; ctx.textAlign = "left";
        ctx.fillText(`> ${m.txt}`, 40, 570 + i*14);
    });
}

function drawInventory() {
    ctx.textAlign = "center"; ctx.fillStyle = COLORS.GOLD; ctx.font = "bold 30px Arial";
    ctx.fillText("HERO'S ARMORY", 480, 60);

    // Sidebar: Stats
    ctx.fillStyle = "rgba(40, 40, 60, 0.95)"; ctx.fillRect(50, 100, 350, 480);
    ctx.textAlign = "left"; ctx.font = "bold 18px Arial"; ctx.fillStyle = COLORS.GOLD;
    ctx.fillText("CHARACTER STATS", 75, 135);

    if (player.points > 0) {
        let pulse = 0.5 + Math.abs(Math.sin(Date.now() / 300)) * 0.5;
        ctx.fillStyle = `rgba(70, 255, 70, ${pulse})`; ctx.font = "bold 14px Arial";
        ctx.fillText(`${player.points} UNSPENT SKILL POINTS!`, 75, 158);
    }

    ["STR", "DEX", "STA", "LUCK"].forEach((s, i) => {
        let total = player[s] + player.bonus[s];
        ctx.font = "16px Arial"; ctx.fillStyle = COLORS.WHITE;
        ctx.fillText(`${s}: ${total} (${player[s]} + ${player.bonus[s]})`, 75, 195 + i*32);
        if(player.points > 0) {
            ctx.fillStyle = COLORS.GREEN; ctx.fillRect(340, 178 + i*32, 22, 22);
            ctx.fillStyle = COLORS.BLACK; ctx.textAlign = "center"; ctx.fillText("+", 351, 195 + i*32);
            ctx.textAlign = "left";
        }
    });

    // Slots for currently equipped weapon/armor
    drawSlot(75, 340, "WEAPON", player.weapon);
    drawSlot(225, 340, "ARMOR", player.armor);

    // Main Inventory Grid with Icons
    ctx.fillStyle = "rgba(10, 10, 20, 0.9)"; ctx.fillRect(430, 100, 480, 410);
    player.inventory.forEach((item, i) => {
        const x = 450 + (i % 5) * 90;
        const y = 120 + Math.floor(i / 5) * 90;
        const isHovered = hoveredItem === item;
        const isEq = (player.weapon === item || player.armor === item);
        ctx.fillStyle = COLORS.SLOT_BG; ctx.fillRect(x, y, 80, 80);
        ctx.strokeStyle = isHovered ? COLORS.GOLD : (isEq ? COLORS.CYAN : COLORS.GRAY);
        ctx.strokeRect(x, y, 80, 80);
        // Correctly calling icon by normalized name
        drawSprite(item.name, x+10, y+10, 60, 60, item.name.substring(0,2), COLORS[`RARITY_${item.rarity}`]);
    });

    if (hoveredItem) drawTooltip(hoveredItem, tooltipPos.x, tooltipPos.y);
    ctx.fillStyle = COLORS.GRAY; ctx.fillRect(430, 530, 150, 40);
    ctx.fillStyle = COLORS.BLACK; ctx.textAlign = "center"; ctx.fillText("BACK", 505, 555);
}

function drawSlot(x, y, label, item) {
    ctx.fillStyle = COLORS.SLOT_BG; ctx.fillRect(x, y, 100, 100);
    ctx.strokeStyle = COLORS.GOLD; ctx.strokeRect(x, y, 100, 100);
    ctx.fillStyle = COLORS.GRAY; ctx.font = "bold 12px Arial"; ctx.textAlign = "center";
    ctx.fillText(label, x + 50, y + 20);
    if(item) drawSprite(item.name, x+15, y+25, 70, 70, item.name.substring(0,3), COLORS[`RARITY_${item.rarity}`]);
}

function drawTooltip(item, x, y) {
    const tw = 240, th = 140;
    ctx.fillStyle = "rgba(0,0,0,0.95)"; ctx.fillRect(x+20, y+20, tw, th);
    ctx.strokeStyle = COLORS[`RARITY_${item.rarity}`]; ctx.strokeRect(x+20, y+20, tw, th);
    ctx.textAlign = "left"; ctx.fillStyle = COLORS[`RARITY_${item.rarity}`]; ctx.font = "bold 16px Arial";
    ctx.fillText(item.name, x+30, y+45);
    const stats = item.type === "weapon" ? ["STR", "LUCK"] : ["STA", "DEX"];
    stats.forEach((s, i) => {
        ctx.font = "12px Arial"; ctx.fillStyle = COLORS.WHITE;
        ctx.fillText(`${s}: ${item[s]}`, x+30, y+75 + i*20);
    });
}

function drawEnd() {
    ctx.fillStyle = "rgba(0,0,0,0.85)"; ctx.fillRect(0,0,960,650);
    ctx.textAlign = "center"; ctx.fillStyle = state === "gameover" ? COLORS.RED : COLORS.GOLD;
    ctx.font = "bold 55px Arial"; ctx.fillText(state === "gameover" ? "DEFEATED" : "LEGEND BORN", 480, 80);
    ctx.fillStyle = "white"; ctx.font = "bold 24px Arial"; ctx.fillText(`FINAL SCORE: ${score}`, 480, 130);
    ctx.fillStyle = "rgba(40, 40, 60, 0.95)"; ctx.fillRect(280, 160, 400, 300);
    ctx.fillStyle = COLORS.GOLD; ctx.font = "28px Arial"; ctx.fillText("HALL OF FAME", 480, 205);
    highScores.slice(0, 5).forEach((s, i) => {
        ctx.fillStyle = (s.name === userName && s.score === score) ? COLORS.CYAN : COLORS.WHITE;
        ctx.font = "20px Arial"; ctx.textAlign = "left"; ctx.fillText(`${i+1}. ${s.name.substring(0,15)}`, 310, 255 + i*40);
        ctx.textAlign = "right"; ctx.fillText(s.score, 650, 255 + i*40);
    });
    ctx.fillStyle = COLORS.GREEN; ctx.fillRect(380, 500, 200, 60);
    ctx.fillStyle = COLORS.BLACK; ctx.textAlign = "center"; ctx.fillText("RETRY", 480, 538);
}

function drawHealthBar(x, y, w, val, max, name) {
    ctx.fillStyle = "rgba(200, 50, 50, 0.3)"; ctx.fillRect(x, y, w, 20);
    ctx.fillStyle = COLORS.GREEN; ctx.fillRect(x, y, w * (Math.max(0, val)/max), 20);
    ctx.strokeStyle = "white"; ctx.strokeRect(x, y, w, 20);
    ctx.fillStyle = COLORS.WHITE; ctx.font = "bold 12px Arial"; ctx.textAlign = "left";
    ctx.fillText(`${name} HP: ${Math.max(0, Math.floor(val))}/${max}`, x, y - 8);
}

canvas.addEventListener('mousemove', e => {
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left, my = e.clientY - r.top;
    hoveredItem = null;
    if (state === "inventory") {
        player.inventory.forEach((item, i) => {
            const x = 450 + (i % 5) * 90;
            const y = 120 + Math.floor(i / 5) * 90;
            if (mx > x && mx < x + 80 && my > y && my < y + 80) { hoveredItem = item; tooltipPos = {x: mx, y: my}; }
        });
    }
});

canvas.addEventListener('mousedown', e => {
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left, my = e.clientY - r.top;
    if (state === "menu" && userName.length > 0) { state = "combat"; initPlayer(); startLevel(1); }
    else if (state === "inventory") {
        ["STR", "DEX", "STA", "LUCK"].forEach((s, i) => {
            if(player.points > 0 && mx > 340 && mx < 362 && my > 178 + i*32 && my < 200 + i*32) {
                player[s]++; player.points--; if(s==="STA") player.hp += 15; calcStats();
            }
        });
        if(mx > 430 && mx < 580 && my > 530 && my < 570) state = "combat";
        player.inventory.forEach((item, i) => {
            const x = 450 + (i % 5) * 90;
            const y = 120 + Math.floor(i / 5) * 90;
            if (mx > x && mx < x + 80 && my > y && my < y + 80) {
                let oldMax = player.maxHp;
                if(item.type === "weapon") player.weapon = item; else player.armor = item;
                calcStats(); if(item.type === "armor") player.hp += (player.maxHp - oldMax);
            }
        });
    } else if (state === "combat") {
        if(mx > 40 && mx < 220 && my > 465 && my < 505) state = "inventory";
        for(let i=1; i<=5; i++) {
            const y = 150 + (i-1) * 75;
            if(mx > 310 && mx < 380 && my > y && my < y+70) {
                if(selBlk.includes(i.toString())) selBlk = selBlk.filter(z => z !== i.toString());
                else if(selBlk.length < 2) selBlk.push(i.toString());
            }
            if(mx > 580 && mx < 650 && my > y && my < y+70) selAtk = i.toString();
        }
        if(selAtk && selBlk.length === 2 && mx > 430 && mx < 530 && my > 495 && my < 540) resolveTurn();
    } else if (state === "gameover" || state === "victory") {
        if(mx > 380 && mx < 580 && my > 500 && my < 560) { state = "menu"; userName = ""; score = 0; currentLvl = 1; }
    }
});

function resolveTurn() {
    let eAtk = Math.floor(Math.random()*5+1).toString();
    let eBlkArr = ["1","2","3","4","5"].sort(()=>.5-Math.random()).slice(0,2);
    if(eBlkArr.includes(selAtk)) addLog(`Enemy blocked your ${ZONE_NAMES[selAtk]}!`, COLORS.YELLOW);
    else {
        let crit = Math.random() < player.crit;
        let d = Math.floor(player.dmg * (crit ? 2 : 1));
        enemy.hp -= d; addLog(`${crit?'CRIT! ':''}Hit for ${d} dmg!`, COLORS.GREEN);
    }
    if(enemy.hp > 0) {
        if(selBlk.includes(eAtk)) addLog(`Blocked their ${ZONE_NAMES[eAtk]}!`, COLORS.CYAN);
        else { player.hp -= enemy.dmg; addLog(`Hit your ${ZONE_NAMES[eAtk]} for ${enemy.dmg} dmg!`, COLORS.RED); }
    }
    selAtk = null; selBlk = []; checkEnd();
}

function checkEnd() {
    if(enemy.hp <= 0) {
        score += (currentLvl * 100);
        if(currentLvl === 10) { saveScore(); state = "victory"; }
        else {
            currentLvl++; startLevel(currentLvl); player.hp = player.maxHp;
            player.points += 2;
            const item = ALL_ITEMS[Math.floor(Math.random()*ALL_ITEMS.length)];
            player.inventory.push(item);
            addLog(`Victory! Found ${item.name}.`, COLORS.GOLD);
        }
    } else if(player.hp <= 0) { saveScore(); state = "gameover"; }
}

function saveScore() {
    highScores.push({name: userName || "Hero", score: score});
    highScores.sort((a,b) => b.score - a.score);
    localStorage.setItem('gauntletScores', JSON.stringify(highScores));
}

window.addEventListener('keydown', e => {
    if(state === "menu") {
        if(e.key === "Enter" && userName.length > 0) { state = "combat"; initPlayer(); startLevel(1); }
        else if(e.key === "Backspace") userName = userName.slice(0, -1);
        else if(userName.length < 12 && e.key.length === 1) userName += e.key;
    }
});

render();
</script>
</body>
</html>